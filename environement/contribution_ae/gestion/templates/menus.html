{% extends 'base.html' %}
{% load permission_tags %}
{%block content%}
{% load static %}
{% load humanize %}
{% block css %}
<style>
   :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --card-shadow: 0 10px 30px rgba(0,0,0,0.1);
      --card-hover-shadow: 0 20px 40px rgba(0,0,0,0.15);
      --border-radius: 16px;
      --text-primary: #2d3748;
      --text-secondary: #718096;
   }

   .modern-dashboard {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
      padding: 2rem 0;
   }

   .dashboard-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--card-shadow);
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.2);
   }

   .dashboard-title {
      font-size: 2.2rem;
      font-weight: 700;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.5rem;
      line-height: 1.3;
   }

   .dashboard-subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 500;
      margin: 0;
   }

   .modern-stat-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
   }

   .modern-stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--primary-gradient);
   }

   .modern-stat-card.success::before {
      background: var(--success-gradient);
   }

   .modern-stat-card.warning::before {
      background: var(--warning-gradient);
   }

   .modern-stat-card.info::before {
      background: var(--info-gradient);
   }

   .modern-stat-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-hover-shadow);
   }

   .stat-value {
      font-size: 2.5rem;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      line-height: 1;
   }

   .stat-label {
      color: var(--text-secondary);
      font-size: 0.95rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0;
   }

   .rate-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      transition: all 0.3s ease;
   }

   .rate-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--card-hover-shadow);
   }

   .rate-input {
      background: transparent;
      border: none;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--text-primary);
      text-align: center;
      width: 100%;
      outline: none;
      margin-bottom: 0.5rem;
   }

   .rate-label {
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0;
   }

   .logo-container {
      text-align: center;
      margin-top: 3rem;
   }

   .logo-container img {
      max-width: 200px;
      height: auto;
      opacity: 0.8;
      transition: opacity 0.3s ease;
   }

   .logo-container img:hover {
      opacity: 1;
   }

   .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
   }

   .rates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
   }

   @media (max-width: 768px) {
      .dashboard-title {
         font-size: 1.8rem;
      }
      
      .modern-stat-card {
         padding: 1.5rem;
      }
      
      .stat-value {
         font-size: 2rem;
      }
      
      .stats-grid,
      .rates-grid {
         grid-template-columns: 1fr;
      }
   }

   .fade-in {
      animation: fadeInUp 0.6s ease-out;
   }

   @keyframes fadeInUp {
      from {
         opacity: 0;
         transform: translateY(30px);
      }
      to {
         opacity: 1;
         transform: translateY(0);
      }
   }
</style>
{% endblock %}

<div class="modern-dashboard">
   <div class="container-fluid">
      <!-- Header moderne -->
      <div class="dashboard-header fade-in">
         <h1 class="dashboard-title">
            Plateforme de Suivi des Contributions
         </h1>
         <p class="dashboard-subtitle">
            Organisations Internationales - 
            {% if exercices is None %}
               Aucun Exercice Ouvert
            {% else %}
               Exercice {{exercices}}
            {% endif %}
         </p>
      </div>

      {% if request.user.is_superuser or user.groupe.name in 'agent,daf,adm,chefequipe' %}
      <!-- Statistiques principales -->
      <div class="stats-grid fade-in">
         <!-- Crédit Actuel -->
         <div class="modern-stat-card">
            <div class="stat-value" id="mt_initial" data-id="{{ligneglobale.credit_actuel}}">
               {{ligneglobale.credit_actuel|intcomma}} GNF
            </div>
            <p class="stat-label">Crédit Actuel</p>
         </div>

         <!-- Crédit Disponible -->
         <div class="modern-stat-card success">
            <div class="stat-value" id="credit_dispo" data-id="{{contributions.total}}">
               {{ligneglobale.credit_disponible|intcomma}} GNF
            </div>
            <p class="stat-label">Crédit Disponible</p>
         </div>

         <!-- Contributions Demandées -->
         <div class="modern-stat-card warning">
            <div class="stat-value" id="demande" data-id="{{contributions.total}}">
               GNF
            </div>
            <p class="stat-label">Contributions Demandées</p>
         </div>

         <!-- Contributions Engagées -->
         <div class="modern-stat-card info">
            <div class="stat-value" id="mt_engage" data-id="{{engagement.total}}">
            </div>
            <p class="stat-label">Contributions Engagées</p>
         </div>

         <!-- Contributions Payées -->
         <div class="modern-stat-card success">
            <div class="stat-value" id="paye" data-id="{{somme.total}}">
            </div>
            <p class="stat-label">Contributions Payées</p>
         </div>
      </div>

      <!-- Taux d'engagement et de paiement -->
      <div class="rates-grid fade-in">
         <div class="rate-card">
            <input type="text" class="rate-input" id="engage" readonly>
            <p class="rate-label">Taux d'Engagement</p>
         </div>
         <div class="rate-card">
            <input type="text" class="rate-input" id="paiement" readonly>
            <p class="rate-label">Taux de Paiement</p>
         </div>
      </div>

      <!-- Logo -->
      <div class="logo-container fade-in">
         <img src="{% static 'images/brandingg-removebg.png' %}" alt="Logo Ministère" class="img-fluid">
      </div>
      {% endif %}
   </div>
</div>

{%endblock content%}
{% block js %}
<script>
   $(document).ready(function () { 
      // Fonction de formatage moderne
      function formatNumber(val) {
         if (!val) return '0';
         
         try {
            const reg = new RegExp("[,.]+", "g");
            let somme = val.toString();
            let formattedNum = 0;
            
            try {
               let sommes = (somme.split(reg)[0]).replace(/\s/g,"");
               formattedNum = parseFloat(sommes).toString().replace(/(\d)(?=(\d{3})+$)/g, '$1 ');
            } catch(error) {
               formattedNum = parseFloat(somme).toString().replace(/(\d)(?=(\d{3})+$)/g, '$1 ');
            }
            return formattedNum;
         } catch(error) {
            return val.toString();
         }
      }

      // Animation des compteurs
      function animateValue(element, start, end, duration = 2000) {
         if (start === end) return;
         const range = end - start;
         let current = start;
         const increment = range / (duration / 16);
         const timer = setInterval(function() {
            current += increment;
            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
               current = end;
               clearInterval(timer);
            }
            element.textContent = formatNumber(current) + ' GNF';
         }, 16);
      }

      // Récupération des données
      let contribution = {{contributions_json|safe}};
      let engagement = {{engagement_json|safe}};
      let somme_paye = {{somme_payee|safe}};
      let tau = {{taux|safe}};
      
      let total_gnf = 0, total_eng = 0, somme_payer = 0;

      // Calcul des sommes payées
      $.each(somme_paye, function(i, obj) {
         $.each(tau, function(j, obj1) {
            let devise = obj.fields.devise;
            if (devise == obj1.fields.devise) {
               somme_payer = parseInt(somme_payer) + parseInt(obj1.fields.taux) * parseInt(obj.fields.paye);
            }
         });
      });

      // Calcul des engagements
      $.each(engagement, function(i, obj) {
         $.each(tau, function(j, obj1) {
            let devise = obj.fields.devise;
            if (devise == obj1.fields.devise) {
               total_eng = parseInt(total_eng) + parseInt(obj1.fields.taux) * parseInt(obj.fields.montant_engage);
            }
         });
      });

      // Calcul des contributions demandées
      $.each(contribution, function(i, obj) {
         $.each(tau, function(j, obj1) {
            let mt_total_devise = parseInt(obj.fields.contribution) + parseInt(obj.fields.arriere);
            let devise = obj.fields.devise;
            if (devise == obj1.fields.devise) {
               total_gnf = parseInt(total_gnf) + parseInt(obj1.fields.taux) * parseInt(mt_total_devise);
            }
         });
      });

      // Mise à jour des éléments avec animations
      const demandeElement = document.getElementById('demande');
      const payeElement = document.getElementById('paye');
      const mt_engageElement = document.getElementById('mt_engage');
      const mt_initial = parseInt($('#mt_initial').data("id"));

      // Animation des valeurs
      setTimeout(() => {
         animateValue(demandeElement, 0, total_gnf);
         animateValue(payeElement, 0, somme_payer);
         animateValue(mt_engageElement, 0, total_eng);
      }, 500);

      // Calcul et affichage des taux avec animation
      setTimeout(() => {
         let engage = (parseInt(total_eng) * 100 / parseInt(mt_initial) || 0);
         let paiement = (parseInt(somme_payer) * 100 / parseInt(mt_initial) || 0);
         
         // Animation des taux
         animateRate('#engage', engage);
         animateRate('#paiement', paiement);
      }, 2500);

      // Fonction d'animation des taux
      function animateRate(selector, targetValue) {
         let current = 0;
         const increment = targetValue / 100;
         const timer = setInterval(function() {
            current += increment;
            if (current >= targetValue) {
               current = targetValue;
               clearInterval(timer);
            }
            $(selector).val(current.toFixed(2) + ' %');
         }, 20);
      }

      // Ajout d'effets visuels
      $('.modern-stat-card').each(function(index) {
         $(this).css('animation-delay', (index * 0.1) + 's');
      });

      // Désactivation du clic droit et F12 (sécurité)
      $(document).bind("contextmenu", function(e) {
         e.preventDefault();
      });

      $(document).keydown(function(e) {
         if (e.which === 123) {
            return false;
         }
      });

      // Effet de parallaxe léger au scroll
      $(window).scroll(function() {
         let scrolled = $(window).scrollTop();
         $('.dashboard-header').css('transform', 'translateY(' + (scrolled * 0.5) + 'px)');
      });
   });
</script>
{% endblock %}
